{% resource 'scheming/scheming-repeating-subfields.js' %}

{% macro repeating_panel(index, index1) %}
  <div class="scheming-subfield-group" data-field="{{ field.field_name }}" data-group-index="{{ index }}">
    <div class="panel panel-primary">
      <header class="panel-heading">
        {{ h.scheming_language_text(field.label) }} {{ index1 }}
      </header>
      <div class="panel-body">
        {% for subfield in field.repeating_subfields %}
          {% set sf = dict(
            subfield,
            field_name=field.field_name ~ '-' ~ index ~ '-' ~ subfield.field_name)
          %}
          {%- snippet 'scheming/snippets/form_field.html',
            field=sf,
            data=flat,
            errors=flaterr,
            licenses=licenses,
            entity_type=entity_type,
            object_type=object_type
          -%}
        {% endfor %}
          {% block removal_popup_button %}
            <a href="javascript:;" id="remove{{ index }}" name="repeating-remove" class="btn btn-danger" data-toggle="modal" data-target="#mid-screen"><i class="fa fa-minus" aria-hidden="true"></i> {{ _('Remove') }}</a>
          {% endblock %}
      </div>
    </div>
  </div>
{% endmacro %}

{#- master snippet for all scheming form fields -#}
{#- render the field the user requested, or use a default field -#}
{%- if field.repeating_subfields %}
  {# A complex field with sub-fields, which can optionally be repeatable. #}
  {% set flat = h.scheming_flatten_subfield(field, data) %}
  {% set flaterr = h.scheming_flatten_subfield(field, errors) %}
  <fieldset name="scheming-repeating-subfields" class="scheming-fieldset" data-module="scheming-repeating-subfields">
    {% set alert_warning = h.scheming_language_text(field.form_alert_warning) %}
    {% if alert_warning %}
      <section class="alert alert-warning">
        {{ alert_warning|safe }}
      </section>
    {% endif %}

    {% set group_data = data[field.field_name] %}
    {% set group_count = group_data|length|default(field.form_blanks, True)|default(1) %}

    {% for index in range(group_count) %}
      {{ repeating_panel(index, index + 1) }}
    {% endfor %}
    <a href="javascript:;" name="repeating-add" class="btn btn-success"><i class="fa fa-plus" aria-hidden="true"></i> {{ _('Add') }}</a>

    {% set help_text = h.scheming_language_text(field.help_text) %}
    {% if help_text %}
      <div class="info-block mrgn-tp-md">
        {{ help_text }}
      </div>
    {% endif %}

    <div name="repeating-template" style="display:none">{{ repeating_panel('REPEATING-INDEX0', 'REPEATING-INDEX1') }}</div>
  </fieldset>

{% block removal_popup %}
  <div class="modal" id="mid-screen" tabindex="-1" role="dialog" aria-labelledby="mid-screenLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mid-screenLabel">{{ _('Confirmation of Removal') }}</h5>
        </div>
        <div class="modal-body" style="text-align:center;">
            <p id="statusText0">{{ _('Are you sure you want to remove') }} {{ h.scheming_language_text(field.label) }} </p><p id="statusText1"></p>
            <p id="statusText2">{{ _('Can not remove, at least one') }} {{ h.scheming_language_text(field.label) }} {{ _('must be present.') }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _('Cancel') }}</button>
          <button name="confirmRemoval" id="confirmRemoval" type="button" class="btn btn-primary" data-dismiss="modal">{{ _('Confirm') }}</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{%- else -%}
  {# A simple field. #}
  {%- set form_snippet = field.form_snippet|default('text.html') -%}

  {%- if '/' not in form_snippet -%}
    {%- set form_snippet = 'scheming/form_snippets/' + form_snippet -%}
  {%- endif -%}

  {%- snippet form_snippet,
    field=field,
    data=data,
    errors=errors,
    licenses=licenses,
    entity_type=entity_type,
    object_type=object_type
  -%}
{%- endif -%}