{% resource 'scheming/scheming-repeating-subfields.js' %}

{#- master snippet for all scheming form fields -#}
{#- render the field the user requested, or use a default field -#}
{%- if field.repeating_subfields %}
  {# A complex field with sub-fields, which can optionally be repeatable. #}
  {% set flat = h.scheming_flatten_subfield(field, data) %}
  <fieldset class="scheming-fieldset" data-module="scheming-repeating-subfields">
    {% set group_data = data[field.field_name] %}
    {% set group_count = group_data|length|default(field.form_blanks, True)|default(1) %}

    {% for index in range(group_count) %}
      {%- if group_data %}
        {% set group_payload = group_data[index] %}
      {% else %}
        {% set group_payload = {} %}
      {% endif -%}
      {% set gnum = loop.index0 %}
      <div class="scheming-subfield-group" data-field="{{ field.field_name }}" data-group-index="{{ index }}">
        <div class="panel panel-default">
          <header class="panel-heading">
            {{ h.scheming_language_text(field.label) }}
          </header>
          <div class="panel-body">
          {% for subfield in field.repeating_subfields %}
            {% set sf = dict(
              subfield,
              field_name=field.field_name ~ '-' ~ gnum ~ '-' ~ subfield.field_name)
            %}
            {%- snippet 'scheming/snippets/form_field.html',
              field=sf,
              data=flat,
              errors=errors,
              licenses=licenses,
              entity_type=entity_type,
              object_type=object_type
            -%}
          {% endfor %}
        </div>
      </div>
    {% endfor %}
    {% set help_text = h.scheming_language_text(field.help_text) %}
    {% if help_text %}
      <div class="info-block">
        {{ help_text }}
      </div>
    {% endif %}
  </fieldset>
{%- else -%}
  {# A simple field. #}
  {%- set form_snippet = field.form_snippet|default('text.html') -%}

  {%- if '/' not in form_snippet -%}
    {%- set form_snippet = 'scheming/form_snippets/' + form_snippet -%}
  {%- endif -%}

  {%- snippet form_snippet,
    field=field,
    data=data,
    errors=errors,
    licenses=licenses,
    entity_type=entity_type,
    object_type=object_type
  -%}
{%- endif -%}
